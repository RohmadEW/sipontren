
    angular.module('mainApp').controller('mdKabupatenController', function ($scope, formHelper, notificationService, $routeParams, $http, $mdDialog, dataScopeShared) {
        $scope.mainURI = $routeParams.ci_dir + '/' + $routeParams.ci_class;
        $scope.ajaxRunning = true;
        $scope.dataUpdate = dataScopeShared.getData('DATA_UPDATE');
        $scope.addForm = true;

        $scope.formData = {
            ID_KAB: null,
            PROVINSI_KAB: null,
            NAMA_KAB: null
        };

        $http.get($scope.mainURI + '/form').then(callbackForm, notificationService.errorCallback);

        function callbackForm(response) {
            $http.get(response.data.uri.kabupaten).then(callbackFormData, notificationService.errorCallback);
        }

        function callbackFormData(response) {
            $scope.dataAutocomplete = response.data;
            $scope.PROVINSI_KAB = formHelper.autocomplete($scope);

            if ($scope.dataUpdate === null || typeof $scope.dataUpdate === 'undefined')
                formReady();
            else
                getData();
        }

        function getData() {
            $http.post($scope.mainURI + '/view', $scope.dataUpdate).then(callbackSuccessData, notificationService.errorCallback);
        }

        function callbackSuccessData(response) {
            angular.forEach($scope.PROVINSI_KAB.dataAll, function (value, key) {
                if (parseInt(response.data.PROVINSI_KAB) === parseInt(value.key)) {
                    $scope.PROVINSI_KAB.selectedItem = value;
                }
            });

            $scope.formData.ID_KAB = response.data.ID_KAB;
            $scope.formData.NAMA_KAB = response.data.NAMA_KAB;
            $scope.formData.PROVINSI_KAB = response.data.PROVINSI_KAB;

            $scope.addForm = false;

            formReady();
        }

        function formReady() {
            $scope.ajaxRunning = false;
        }

        $scope.cancelSumbit = function () {
            dataScopeShared.addData('DATA_UPDATE', null);
            $mdDialog.cancel();
        };

        $scope.saveSubmit = function () {
            if ($scope.form.PROVINSI_KAB.$valid && $scope.form.NAMA_KAB.$valid) {
                $scope.ajaxRunning = true;

                $http.post($scope.mainURI + '/save', $scope.formData).then(callbackSuccessSaving, notificationService.errorCallback);
            } else {
                notificationService.toastSimple('Silahkan periksa kembali masukan Anda');
            }
        };

        function callbackSuccessSaving(response) {
            $scope.ajaxRunning = false;
            $mdDialog.hide(response.data.notification.text);
            dataScopeShared.addData('DATA_UPDATE', null);
        }

        $scope.$watch('PROVINSI_KAB.selectedItem', function (selectedItem) {
            if (typeof selectedItem === 'undefined' || selectedItem.key === null)
                $scope.formData.PROVINSI_KAB = null;
            else
                $scope.formData.PROVINSI_KAB = selectedItem.key;
        });
    });